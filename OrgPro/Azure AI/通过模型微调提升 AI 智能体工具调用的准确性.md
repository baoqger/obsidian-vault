
11月底微软举行了2025 Ignite大会(这个大会明显不如AWS的re:Invent话题度高), Chris一直以来都在持续关注微软AI平台(微软虽然不受普通人待见, 但是它的平台自然有其受众群体, 有客户, 就有生意, 也就有我们的一些些机会). Ignite大会上 ,发布了最新的Microsoft Foundry平台, 并且展示了很多技术案例的演示, 后续Chris会给大家逐步拆解. 

今天先从Fine Tune Model这个比较复杂的话题入手: 通过模型微调提升 AI 智能体工具调用的准确性(可以按照这个英文标题去搜 Enhancing AI Agent tool-calling accuracy through Fine-Tuning) 

### 背景问题

Agent调用工具(Tool)来获取外界数据或者完成一些任务, 这是Agent最常见的一个工作模式了. 

这种模式, 对于只需要一次(或者少数几次)工具调用就能解决的简单问题, 一般都能稳定处理! 

但是如果当用户的提问变得很复杂时, Agent还能计划出很好的工具调用吗? 制定出的计划, 还能稳定执行吗? 如果不能, 在什么场合适合Fine Model这个方案呢? 

### 项目背景

这个案例虚构一个名为 **Zava** 的零售品牌。该品牌提供由一个 **Retail MCP 服务器** 驱动的客服 AI 智能体，该MCP服务器对外暴露了各种工具（商品搜索、用户查询、订单详情、退货、换货、资料更新等）。

![[Pasted image 20251215205407.png]]

### 简单用例可以正常工作

我们先展示基础模型（例如 `gpt-4.1-mini`）可以正确处理**简单的工具调用**。  
比如，像下面这样的请求：

> “Can you show me all your products?”（“你能把你们所有的商品都给我看看吗？”）

会被解析为正确的 MCP 工具调用，并产生预期结果。

智能体通常会按如下方式响应：

1. 将该请求理解为浏览商品的意图
2. 调用合适的 MCP 工具（例如 `list_products`），且**不带任何参数**
3. 向用户返回一个友好的、分页展示的商品列表

![[Pasted image 20251215210209.png]]

### 更真实的场景失败：更新我的地址

现在来看一个更加真实、且与策略高度相关的场景。

一位回访客户在搬家后希望**更新自己的地址**：

> “Hi, I want to update my address.”  
> （“嗨，我想更新一下我的地址。”）

根据写进Agent系统指令里的策略，我们知道智能体应该：

1. **对用户进行身份验证**
    - 询问邮箱，或
    - 询问名字、姓氏以及邮政编码（ZIP code）
2. 调用 `find_user_id_by_name_zip` 或 `find_user_id_by_email`, 返回user_id
3. 立即使用返回的 `user_id` 调用 `get_user_details`
4. 展示当前地址，并请用户确认新地址
5. 使用正确的 `user_id` 和新地址调用 `update_address`
6. 确认更新已完成

下面记录了一段真实对话：在这段对话中，发现智能体的行为**并不正确**。

![[Pasted image 20251215211314.png]]

通过查看打印出的对话记录，我们可以发现如下模式：

1. 用户请求更新自己的地址。
    
2. 助手正确地询问了身份信息（姓名 + 邮政编码）。
    
3. 用户回答，例如：“My name is Noah Brown and ZIP is 80279”（“我叫 Noah Brown，邮编是 80279”）。
    
4. 智能体调用工具：find_user_id_by_name_zip, 该工具返回了一个有效的 user_id :noah_brown_6181, 这是正确的行为! 

5. 之后，当用户说 “can you show me my current details first”时，智能体调用工具：get_user_details, 参数是 { "user_id": "noah_brown_80279" } 这是错误的——模型并没有使用刚刚返回的 user_id（noah_brown_6181），而是幻觉出一个user_id 的值( noah_brown_80279）


### 这个失败场景为何重要

这个失败场景之所以重要，是因为它凸显了构建可靠的工具调用型智能体时遇到的真实挑战：

- 这不是自然语言理解问题, 模型是理解这个请求的。  

- 这不是工具选择问题: 模型选择了正确的工具

- 这是工具参数传递（propagation）的问题, 这是一个**结构性错误**

- 这是策略合规性失败, 因为Agent的系统提示词中, 明确要求了: 
	- 对用户进行身份验证
	- 立刻检索用户档案
	- 正确传递返回的 `user_id`
	- 绝不能凭空编造标识符
	- 绝不能在对话中途凭空“换一个”用户

 - 这是数据模型一致性失败, 因为被幻觉出来的用户 ID 在 MPC服务的数据后台中根本不存在, 这意味着：
	- 模型并没有基于真实后端数据, 生成对话
	- 模型也没有把工具输出结果当作权威来源
	- 模型破坏了多轮对话中的状态连续性


fine tune model

![[Pasted image 20251219214551.png]]







